<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nokia 3310 Ringtone Maker</title>

    <!-- CSS Section -->
    <style>
    </style>
</head>

<body>

<!-- Header Section -->
<header>
</header>

<!-- Main Content Section -->
<main>

    <button id="createButton">Create</button>

</main>

<!-- JavaScript Section -->
<script src="https://unpkg.com/tone"></script>
<script>

    // GLOBAL STATE

    let toneLoaded = false;
    let g_synth = null;

    // EVENT BINDINGS

    document.getElementById('createButton').addEventListener('click', onCreateButtonClick);

    // EVENT HANDLERS

    async function onCreateButtonClick() {
        // TODO kmere What happens if clicked twice quickly?
        console.log("onCreateButtonClick");

        // Load Tone.js on first click
        if (!toneLoaded) {
            await loadTone();
            toneLoaded = true;
        }

        // Initialize synth on first click if not already created
        if (!g_synth) {
            g_synth = new Tone.Synth({ oscillator: { type: 'square' } }).toDestination();
        }

        // Start audio context
        await Tone.start();

        const notes = [{time: 0, note: "A4", dur: "4n"}, {time: "+0.5", note: "F4", dur: "8n"}, {time: "+0.75", note: "G4", dur: "8n"}];

        const part = new Tone.Part((time, note) => {
            g_synth.triggerAttackRelease(note.note, note.dur, time);
        }, notes.map(n => [n.time, n]));

        part.start(Tone.now());
    }

    function loadTone() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = "https://unpkg.com/tone";
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
        });
    }
</script>

</body>

</html>
